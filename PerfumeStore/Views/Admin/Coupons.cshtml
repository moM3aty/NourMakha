@model List<PerfumeStore.Models.Coupon>
@{
    ViewData["Title"] = System.Globalization.CultureInfo.CurrentCulture.Name == "ar" ? "إدارة الكوبونات" : "Coupons Management";
    var isArabic = System.Globalization.CultureInfo.CurrentCulture.Name == "ar";
    Layout = "_AdminLayout";
}

<div class="page-content-wrapper animate-fade-up">
    <!-- Header Section -->
    <div class="page-header-premium">
        <div class="header-content">
            <div class="title-wrapper">
                <div class="icon-box">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div>
                    <h1>@ViewData["Title"]</h1>
                    <p>@(isArabic ? "إدارة خصومات المتجر وكوبونات المشاهير" : "Manage store discounts and celebrity coupons")</p>
                </div>
            </div>
            <a href="/Admin/CreateCoupon" class="btn-add-new">
                <i class="fas fa-plus"></i>
                <span>@(isArabic ? "كوبون جديد" : "New Coupon")</span>
            </a>
        </div>
    </div>

    <!-- Filter & Toolbar Section -->
    <div class="toolbar-container animate-fade-up delay-1">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="couponSearch" placeholder="@(isArabic ? "بحث بكود الكوبون..." : "Search by coupon code...")" onkeyup="filterCoupons()">
        </div>

        <div class="filters-wrapper">
            <div class="select-wrapper">
                <select id="statusFilter" onchange="filterCoupons()">
                    <option value="all">@(isArabic ? "كل الحالات" : "All Status")</option>
                    <option value="active">@(isArabic ? "نشط" : "Active")</option>
                    <option value="expired">@(isArabic ? "منتهي / معطل" : "Expired / Inactive")</option>
                </select>
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
            <div class="select-wrapper">
                <select id="typeFilter" onchange="filterCoupons()">
                    <option value="all">@(isArabic ? "كل الأنواع" : "All Types")</option>
                    <option value="percentage">@(isArabic ? "نسبة مئوية" : "Percentage")</option>
                    <option value="fixed">@(isArabic ? "مبلغ ثابت" : "Fixed Amount")</option>
                </select>
                <i class="fas fa-chevron-down arrow-icon"></i>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success animate-fade-up" style="background: #e8f5e9; color: #2e7d32; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #c8e6c9; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-circle"></i> @TempData["Success"]
        </div>
    }

    <!-- Coupons Table Card -->
    <div class="table-card animate-fade-up delay-2">
        <div class="table-responsive">
            <table class="premium-table" id="couponsTable">
                <thead>
                    <tr>
                        <th>@(isArabic ? "كود الخصم" : "Coupon Code")</th>
                        <th>@(isArabic ? "نوع وقيمة الخصم" : "Type & Value")</th>
                        <th>@(isArabic ? "الحد الأدنى" : "Min. Order")</th>
                        <th>@(isArabic ? "الاستخدام" : "Usage")</th>
                        <th>@(isArabic ? "تاريخ الانتهاء" : "Expiry Date")</th>
                        <th>@(isArabic ? "الحالة" : "Status")</th>
                        <th class="text-end">@(isArabic ? "إجراءات" : "Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var coupon in Model)
                    {
                        var isActive = coupon.IsActive && (!coupon.EndDate.HasValue || coupon.EndDate > DateTime.Now);
                        var statusKey = isActive ? "active" : "expired";
                        var typeKey = coupon.DiscountType.ToLower();

                        <tr class="coupon-row"
                            data-code="@coupon.Code.ToLower()"
                            data-status="@statusKey"
                            data-type="@typeKey">
                            <td>
                                <span class="coupon-code-badge">@coupon.Code</span>
                            </td>
                            <td>
                                <div class="discount-info">
                                    <span class="value">
                                        @if (coupon.DiscountType == "Percentage")
                                        {
                                            @($"{coupon.DiscountValue}%")
                                        }
                                        else
                                        {
                                            @($"{coupon.DiscountValue} OMR")
                                        }
                                    </span>
                                    <span class="type-label">@(coupon.DiscountType == "Percentage" ? (isArabic ? "خصم نسبي" : "Percentage") : (isArabic ? "مبلغ ثابت" : "Fixed"))</span>
                                </div>
                            </td>
                            <td>
                                <span class="min-order">@(coupon.MinimumOrderAmount?.ToString("N2") ?? "0.00") <small>OMR</small></span>
                            </td>
                            <td>
                                <div class="usage-stack">
                                    <span class="count">@coupon.UsedCount / @(coupon.UsageLimit?.ToString() ?? "∞")</span>
                                    <div class="progress-mini">
                                        @{
                                            var percent = coupon.UsageLimit.HasValue ? (double)coupon.UsedCount / coupon.UsageLimit.Value * 100 : 0;
                                        }
                                        <div class="fill" style="width: @(percent > 100 ? 100 : percent)%"></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-cell">
                                    @if (coupon.EndDate.HasValue)
                                    {
                                        <span class="day">@coupon.EndDate.Value.ToString("dd MMM yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="no-limit">@(isArabic ? "غير محدود" : "No Limit")</span>
                                    }
                                </div>
                            </td>
                            <td>
                                <span class="status-badge-pro @statusKey">
                                    <span class="dot"></span>
                                    @(isActive ? (isArabic ? "نشط" : "Active") : (isArabic ? "منتهي" : "Expired"))
                                </span>
                            </td>
                            <td>
                                <div class="actions-group">
                                    <a href="/Admin/EditCoupon/@coupon.Id" class="action-btn edit" title="@(isArabic ? "تعديل" : "Edit")">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    <form action="/Admin/DeleteCoupon/@coupon.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="action-btn delete" onclick="return confirm('@(isArabic ? "تأكيد حذف الكوبون؟" : "Confirm delete coupon?")')" title="@(isArabic ? "حذف" : "Delete")">
                                            <i class="far fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (!Model.Any())
            {
                <div class="empty-data">
                    <i class="fas fa-ticket-alt"></i>
                    <h3>@(isArabic ? "لا توجد كوبونات مضافة" : "No Coupons Found")</h3>
                </div>
            }
        </div>
    </div>
</div>

<style>
    /* --- Premium UI Components --- */
    .page-header-premium {
        background: #fff;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 40, 85, 0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .title-wrapper {
        display: flex;
        align-items: center;
        gap: 1.2rem;
    }

    .icon-box {
        width: 54px;
        height: 54px;
        background: linear-gradient(135deg, #002855, #004080);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.4rem;
        box-shadow: 0 10px 20px rgba(0, 40, 85, 0.15);
    }

    .title-wrapper h1 {
        font-size: 1.6rem;
        color: #1e293b;
        margin: 0;
        font-family: 'Tajawal', sans-serif;
    }

    .title-wrapper p {
        color: #64748b;
        margin: 5px 0 0;
        font-size: 0.95rem;
    }

    .btn-add-new {
        background: #002855;
        color: #fff;
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        font-weight: 700;
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(0, 40, 85, 0.2);
    }

        .btn-add-new:hover {
            transform: translateY(-2px);
            background: #004080;
            color: #fff;
        }

    /* --- Toolbar --- */
    .toolbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .search-wrapper {
        position: relative;
        flex: 1;
        min-width: 300px;
    }

        .search-wrapper input {
            width: 100%;
            padding: 0.9rem 1.2rem;
            padding-inline-start: 3rem;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            transition: 0.3s;
            font-size: 0.95rem;
        }

            .search-wrapper input:focus {
                border-color: #002855;
                box-shadow: 0 0 0 4px rgba(0, 40, 85, 0.05);
                outline: none;
            }

    .search-icon {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        inset-inline-start: 1.2rem;
        color: #94a3b8;
    }

    .filters-wrapper {
        display: flex;
        gap: 1rem;
    }

    .select-wrapper {
        position: relative;
        min-width: 160px;
    }

        .select-wrapper select {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            background: #fff;
            border: 1px solid #e2e8f0;
            color: #475569;
            appearance: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .select-wrapper .arrow-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            inset-inline-end: 1rem;
            color: #94a3b8;
            pointer-events: none;
        }

    /* --- Table Card --- */
    .table-card {
        background: #fff;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        box-shadow: 0 4px 25px rgba(0,0,0,0.03);
    }

    .premium-table {
        width: 100%;
        border-collapse: collapse;
    }

        .premium-table thead {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .premium-table th {
            padding: 1.2rem 1.5rem;
            text-align: start;
            color: #64748b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .premium-table td {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

    .coupon-code-badge {
        display: inline-block;
        font-family: 'Courier New', Courier, monospace;
        background: #f1f5f9;
        color: #002855;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 1.1rem;
        border: 1.5px dashed #002855;
        letter-spacing: 1px;
    }

    .discount-info {
        display: flex;
        flex-direction: column;
    }

        .discount-info .value {
            font-weight: 800;
            color: #002855;
            font-size: 1.1rem;
        }

        .discount-info .type-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }

    .min-order {
        font-weight: 600;
        color: #475569;
    }

        .min-order small {
            color: #94a3b8;
        }

    .usage-stack {
        width: 120px;
    }

        .usage-stack .count {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

    .progress-mini {
        height: 6px;
        background: #f1f5f9;
        border-radius: 10px;
        overflow: hidden;
    }

        .progress-mini .fill {
            height: 100%;
            background: #002855;
            border-radius: 10px;
        }

    .status-badge-pro {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-radius: 30px;
        font-size: 0.8rem;
        font-weight: 700;
    }

        .status-badge-pro .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

    .active {
        background: #ecfdf5;
        color: #059669;
    }

        .active .dot {
            background: #10b981;
        }

    .expired {
        background: #fef2f2;
        color: #991b1b;
    }

        .expired .dot {
            background: #ef4444;
        }

    .actions-group {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
        transition: 0.2s;
    }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .action-btn.edit:hover {
            color: #002855;
            border-color: #002855;
            background: rgba(0, 40, 85, 0.05);
        }

        .action-btn.delete:hover {
            color: #ef4444;
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

    .empty-data {
        padding: 4rem;
        text-align: center;
        color: #cbd5e1;
    }

        .empty-data i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

    @@media (max-width: 992px) {
        .toolbar-container {
            flex-direction: column;
            align-items: stretch;
        }

        .premium-table th:nth-child(3), .premium-table td:nth-child(3),
        .premium-table th:nth-child(4), .premium-table td:nth-child(4) {
            display: none;
        }
    }
</style>

<script>
    function filterCoupons() {
        const searchText = document.getElementById('couponSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const rows = document.querySelectorAll('.coupon-row');

        rows.forEach(row => {
            const code = row.getAttribute('data-code');
            const status = row.getAttribute('data-status');
            const type = row.getAttribute('data-type');

            let matchesSearch = code.includes(searchText);
            let matchesStatus = statusFilter === 'all' || status === statusFilter;
            let matchesType = typeFilter === 'all' || type === typeFilter;

            if (matchesSearch && matchesStatus && matchesType) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }
</script>