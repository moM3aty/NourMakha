@model PerfumeStore.ViewModels.CheckoutViewModel
@using PerfumeStore.Data
@inject ApplicationDbContext _context
@{
    ViewData["Title"] = System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar") ? "إتمام الطلب" : "Checkout";
    var isArabic = System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar");

    // جلب مناطق الشحن
    var shippingZones = _context.Set<PerfumeStore.Models.ShippingZone>().Where(z => z.IsActive).ToList();

    // الكوبون المحفوظ إن وجد
    var savedCoupon = ViewBag.SavedCoupon as string;
    var cartSubtotal = (decimal)ViewBag.CartSubtotal;
}

<div class="checkout-page-wrapper animate-fade-up">
    <div class="container">
        <!-- Header -->
        <div class="checkout-header-centered">
            <h1>@ViewData["Title"]</h1>
            <div class="trust-badges">
                <span class="badge"><i class="fas fa-lock"></i> @(isArabic ? "دفع آمن ومحمي" : "Secure Encrypted Payment")</span>
                <span class="badge"><i class="fas fa-shield-alt"></i> @(isArabic ? "بياناتك سرية" : "Data Privacy")</span>
            </div>
        </div>

        <form asp-action="Checkout" method="post" id="checkoutForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="UserId" />

            <!-- هام: حقل مخفي للكوبون يتم تحديثه بالجافاسكريبت عند نجاح الخصم -->
            <input type="hidden" name="CouponCode" id="hiddenCouponCode" value="@savedCoupon" />

            <div class="checkout-grid-premium">
                <!-- Left Side: Information Form -->
                <div class="checkout-main">
                    <!-- 1. Shipping Details -->
                    <div class="checkout-card">
                        <div class="card-header-clean">
                            <span class="step-circle">1</span>
                            <h2>@(isArabic ? "بيانات التوصيل" : "Shipping Details")</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-grid-2">
                                <div class="form-group-float">
                                    <input asp-for="FirstName" class="form-input" placeholder=" " required />
                                    <label asp-for="FirstName">@(isArabic ? "الاسم الأول" : "First Name")</label>
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                                <div class="form-group-float">
                                    <input asp-for="LastName" class="form-input" placeholder=" " required />
                                    <label asp-for="LastName">@(isArabic ? "الاسم الأخير" : "Last Name")</label>
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="form-group-float">
                                <input asp-for="Email" type="email" class="form-input" placeholder=" " required />
                                <label asp-for="Email">@(isArabic ? "البريد الإلكتروني" : "Email Address")</label>
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>

                            <div class="form-group-float">
                                <input asp-for="Phone" type="tel" class="form-input" placeholder=" " required />
                                <label asp-for="Phone">@(isArabic ? "رقم الهاتف" : "Phone Number")</label>
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>

                            <!-- Shipping Zone Selection -->
                            <div class="form-group-float">
                                <select asp-for="ShippingZoneId" id="shippingZoneSelector" class="form-input" onchange="calculateTotals()" required>
                                    <option value="" data-cost="0">@(isArabic ? "-- اختر المنطقة --" : "-- Select Zone --")</option>
                                    @foreach (var zone in shippingZones)
                                    {
                                        <option value="@zone.Id" data-cost="@zone.Cost">@(isArabic? zone.NameAr: zone.NameEn) (+@zone.Cost OMR)</option>
                                    }
                                </select>
                                <label asp-for="ShippingZoneId">@(isArabic ? "منطقة الشحن" : "Shipping Zone")</label>
                                <span asp-validation-for="ShippingZoneId" class="text-danger"></span>
                            </div>

                            <div class="form-grid-2">
                                <div class="form-group-float">
                                    <select asp-for="Country" class="form-input" disabled>
                                        <option value="Oman" selected>@(isArabic ? "سلطنة عمان" : "Sultanate of Oman")</option>
                                    </select>
                                    <label asp-for="Country">@(isArabic ? "الدولة" : "Country")</label>
                                </div>
                                <div class="form-group-float">
                                    <input asp-for="City" class="form-input" placeholder=" " required />
                                    <label asp-for="City">@(isArabic ? "المدينة / الولاية" : "City / Wilayat")</label>
                                </div>
                            </div>

                            <div class="form-group-float">
                                <input asp-for="Address" class="form-input" placeholder=" " required />
                                <label asp-for="Address">@(isArabic ? "العنوان (الشارع، رقم المنزل)" : "Street Address")</label>
                            </div>

                            <div class="form-group-float">
                                <textarea asp-for="Notes" class="form-input" placeholder=" " rows="2"></textarea>
                                <label asp-for="Notes">@(isArabic ? "ملاحظات إضافية" : "Additional Notes")</label>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Payment Method -->
                    <div class="checkout-card mt-4">
                        <div class="card-header-clean">
                            <span class="step-circle">2</span>
                            <h2>@(isArabic ? "طريقة الدفع" : "Payment Method")</h2>
                        </div>
                        <div class="card-body">
                            <div class="payment-selection-grid">
                                <!-- Cash -->
                                <label class="payment-method-card selected">
                                    <input type="radio" asp-for="PaymentMethod" value="CashOnDelivery" checked name="PaymentMethod" onchange="updatePaymentSelection(this)" />
                                    <div class="card-content">
                                        <div class="method-icon"><i class="fas fa-money-bill-wave"></i></div>
                                        <div class="method-details">
                                            <span class="title">@(isArabic ? "الدفع عند الاستلام" : "Cash on Delivery")</span>
                                            <span class="desc">@(isArabic ? "ادفع نقداً عند وصول طلبك" : "Pay cash upon delivery")</span>
                                        </div>
                                        <div class="check-circle"><i class="fas fa-check"></i></div>
                                    </div>
                                </label>

                                <!-- Credit Card / Thawani Pay -->
                                <label class="payment-method-card">
                                    <input type="radio" asp-for="PaymentMethod" value="CreditCard" name="PaymentMethod" onchange="updatePaymentSelection(this)" />
                                    <div class="card-content">
                                        <div class="method-icon"><i class="far fa-credit-card"></i></div>
                                        <div class="method-details">
                                            <span class="title">@(isArabic ? "بطاقة ائتمان / خصم مباشر" : "Credit / Debit Card")</span>

                                            <!-- أرقام وصور البطاقات المدعومة -->
                                            <div class="card-logos-wrapper">
                                                <img src="https://www.logo.wine/a/logo/Visa_Inc./Visa_Inc.-Logo.wine.svg" alt="Visa" class="pay-logo" />
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="pay-logo" />
                                                <div class="omannet-badge-mini" title="OmanNet">OmanNet</div>
                                                <img src="https://thawani.om/wp-content/uploads/2022/12/Outlook-A-green-an.png" alt="Thawani" class="pay-logo thawani" title="Powered by Thawani" />
                                            </div>

                                        </div>
                                        <div class="check-circle"><i class="fas fa-check"></i></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Order Summary -->
                <aside class="checkout-sidebar">
                    <div class="summary-card-premium">
                        <div class="summary-header">
                            <h3>@(isArabic ? "ملخص الطلب" : "Order Summary")</h3>
                        </div>

                        <!-- Coupon Section -->
                        <div class="coupon-section">
                            <label>@(isArabic ? "هل لديك كود خصم؟" : "Have a coupon?")</label>
                            <div class="coupon-input-wrapper">
                                <!-- حقل ظاهري فقط -->
                                <input id="couponInput" value="@savedCoupon" placeholder="@(isArabic ? "ادخل الكود" : "Enter Code")" />
                                <button type="button" onclick="validateCoupon()">@(isArabic ? "تطبيق" : "Apply")</button>
                            </div>
                            <span id="couponFeedback" class="coupon-feedback"></span>
                        </div>

                        <!-- Totals -->
                        <div class="totals-section">
                            <div class="total-row">
                                <span>@(isArabic ? "المجموع الفرعي" : "Subtotal")</span>
                                <!-- تخزين القيمة الأساسية في data attribute للحساب -->
                                <span id="subtotalDisplay" class="currency-price" data-base-price="@cartSubtotal">@cartSubtotal OMR</span>
                            </div>

                            <div class="total-row">
                                <span>@(isArabic ? "الشحن" : "Shipping")</span>
                                <span id="shippingDisplay" class="currency-price" data-base-price="0">0.00 OMR</span>
                            </div>

                            <div class="total-row discount" id="discountRow" style="display:none;">
                                <span>@(isArabic ? "الخصم" : "Discount")</span>
                                <span id="discountDisplay" class="currency-price" data-base-price="0">-0.00 OMR</span>
                            </div>

                            <div class="total-divider"></div>

                            <div class="total-row grand-total">
                                <span>@(isArabic ? "الإجمالي" : "Total")</span>
                                <span id="totalDisplay" class="gold-text currency-price" data-base-price="@cartSubtotal">@cartSubtotal OMR</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-complete-order">
                            <span>@(isArabic ? "تأكيد الطلب" : "Place Order")</span>
                            <i class="fas fa-lock"></i>
                        </button>

                        <div class="security-footer">
                            <i class="fas fa-shield-alt"></i> @(isArabic ? "جميع المعاملات مشفرة وآمنة" : "All transactions are secure and encrypted")
                        </div>
                    </div>
                </aside>
            </div>
        </form>
    </div>
</div>

<style>
    /* Premium Checkout Styles */
    .checkout-page-wrapper {
        padding: 3rem 0 5rem;
        background: #f8f9fa;
        min-height: 100vh;
        margin-top: 80px;
    }

    .checkout-header-centered {
        text-align: center;
        margin-bottom: 3rem;
    }

        .checkout-header-centered h1 {
            color: #002855;
            font-family: 'Playfair Display', serif;
            margin-bottom: 0.5rem;
        }

    .trust-badges .badge {
        background: #fff;
        padding: 5px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #6c757d;
        font-size: 0.9rem;
    }

    .checkout-grid-premium {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
    }

    .checkout-card, .summary-card-premium {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        border: 1px solid rgba(0,40,85,0.05);
        overflow: hidden;
    }

    .card-header-clean {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .step-circle {
        width: 32px;
        height: 32px;
        background: #002855;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .card-header-clean h2 {
        font-size: 1.2rem;
        margin: 0;
        color: #1e293b;
    }

    .card-body {
        padding: 2rem;
    }

    /* Inputs */
    .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group-float {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .form-input {
        width: 100%;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: 0.2s;
        background: #fff;
    }

        .form-input:focus {
            border-color: #002855;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,40,85,0.05);
        }

    .form-group-float label {
        position: absolute;
        left: 1rem;
        top: 1rem;
        color: #94a3b8;
        transition: 0.2s;
        pointer-events: none;
        background: #fff;
        padding: 0 5px;
    }

    .form-input:focus ~ label, .form-input:not(:placeholder-shown) ~ label {
        top: -0.6rem;
        left: 0.8rem;
        font-size: 0.8rem;
        color: #002855;
        font-weight: 600;
    }

    /* RTL Adjustments */
    body.rtl .form-group-float label {
        left: auto;
        right: 1rem;
    }

    body.rtl .form-input:focus ~ label, body.rtl .form-input:not(:placeholder-shown) ~ label {
        right: 0.8rem;
        left: auto;
    }

    /* Payment Cards */
    .payment-selection-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .payment-method-card {
        cursor: pointer;
        position: relative;
    }

        .payment-method-card input {
            display: none;
        }

    .card-content {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        border: 2px solid #f8f9fa;
        border-radius: 12px;
        transition: 0.2s;
    }

    .payment-method-card input:checked + .card-content {
        border-color: #002855;
        background: rgba(0,40,85,0.02);
    }

    .method-icon {
        font-size: 1.5rem;
        color: #002855;
        width: 40px;
        text-align: center;
    }

    .method-details .title {
        display: block;
        font-weight: 700;
        color: #1e293b;
    }

    .method-details .desc {
        font-size: 0.85rem;
        color: #64748b;
    }

    .check-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #e2e8f0;
        margin-inline-start: auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .payment-method-card input:checked + .card-content .check-circle {
        background: #002855;
        border-color: #002855;
        color: #fff;
        font-size: 0.8rem;
    }

    /* --- Payment Logos CSS --- */
    .card-logos-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
        flex-wrap: wrap;
    }

    .pay-logo {
        height: 16px;
        width: auto;
        object-fit: contain;
        opacity: 0.5;
        filter: grayscale(100%);
        transition: 0.3s;
    }

    .omannet-badge-mini {
        height: 16px;
        background: #0076a8;
        color: #fff;
        padding: 0 6px;
        border-radius: 3px;
        display: flex;
        align-items: center;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 0.6rem;
        letter-spacing: 0.5px;
        opacity: 0.5;
        filter: grayscale(100%);
        transition: 0.3s;
    }

    .pay-logo.thawani {
        height: 14px;
        margin-inline-start: 5px;
        border-inline-start: 1px solid #e2e8f0;
        padding-inline-start: 8px;
    }

    /* Colorize on select */
    .payment-method-card input:checked + .card-content .pay-logo,
    .payment-method-card input:checked + .card-content .omannet-badge-mini {
        opacity: 1;
        filter: grayscale(0%);
    }

    /* Sidebar Summary */
    .summary-card-premium {
        padding: 2rem;
        position: sticky;
        top: 100px;
    }

    .summary-header h3 {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: #002855;
        font-weight: 700;
    }

    .coupon-section {
        margin-bottom: 2rem;
    }

        .coupon-section label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #64748b;
        }

    .coupon-input-wrapper {
        display: flex;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

        .coupon-input-wrapper input {
            border: none;
            padding: 0.8rem;
            flex: 1;
            outline: none;
        }

        .coupon-input-wrapper button {
            background: #002855;
            color: #fff;
            border: none;
            padding: 0 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

            .coupon-input-wrapper button:hover {
                background: #004080;
            }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
        color: #64748b;
    }

    .total-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 1rem 0;
    }

    .total-row.grand-total {
        font-size: 1.3rem;
        font-weight: 800;
        color: #002855;
        margin-bottom: 0;
    }

    .total-row.discount {
        color: #166534;
        font-weight: 600;
    }

    .btn-complete-order {
        width: 100%;
        padding: 1rem;
        background: #002855;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 2rem;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(0,40,85,0.2);
    }

        .btn-complete-order:hover {
            transform: translateY(-2px);
            background: #003377;
        }

    .security-footer {
        text-align: center;
        margin-top: 1.5rem;
        font-size: 0.8rem;
        color: #2ecc71;
        font-weight: 600;
    }

    .coupon-feedback {
        display: block;
        margin-top: 5px;
        font-size: 0.85rem;
    }

        .coupon-feedback.success {
            color: #166534;
        }

        .coupon-feedback.error {
            color: #dc2626;
        }

    @@media (max-width: 992px) {
        .checkout-grid-premium {
            grid-template-columns: 1fr;
        }

        .checkout-sidebar {
            order: -1;
        }
    }
</style>

<script>
    // متغير لتخزين قيمة الخصم الحالية في الجافاسكريبت للحساب
    let currentDiscountAmount = 0;

    document.addEventListener("DOMContentLoaded", function() {
        // إذا كان هناك كوبون محفوظ، قم بالتحقق منه تلقائياً
        const savedCode = document.getElementById('couponInput').value;
        if(savedCode) {
            validateCoupon();
        }
    });

    function updatePaymentSelection(radio) {
        document.querySelectorAll('.payment-method-card').forEach(el => el.classList.remove('selected'));
        if(radio.checked) {
            radio.closest('.payment-method-card').classList.add('selected');
        }
    }

    // دالة الحساب الفوري
    function calculateTotals() {
        // 1. المجموع الفرعي (ثابت)
        const subtotalEl = document.getElementById('subtotalDisplay');
        const subtotal = parseFloat(subtotalEl.getAttribute('data-base-price'));

        // 2. تكلفة الشحن
        const shippingSelect = document.getElementById('shippingZoneSelector');
        let shippingCost = 0;
        if(shippingSelect && shippingSelect.selectedIndex > 0) {
            const option = shippingSelect.options[shippingSelect.selectedIndex];
            shippingCost = parseFloat(option.getAttribute('data-cost')) || 0;
        }

        // 3. الحساب النهائي
        let total = subtotal + shippingCost - currentDiscountAmount;
        if (total < 0) total = 0;

        // 4. تحديث الواجهة
        // الشحن
        const shipEl = document.getElementById('shippingDisplay');
        shipEl.innerText = shippingCost.toFixed(2) + " OMR";
        shipEl.setAttribute('data-base-price', shippingCost);

        // الخصم
        const discRow = document.getElementById('discountRow');
        const discEl = document.getElementById('discountDisplay');
        if (currentDiscountAmount > 0) {
            discRow.style.display = 'flex';
            discEl.innerText = "-" + currentDiscountAmount.toFixed(2) + " OMR";
            discEl.setAttribute('data-base-price', currentDiscountAmount);
        } else {
            discRow.style.display = 'none';
        }

        // الإجمالي
        const totalEl = document.getElementById('totalDisplay');
        totalEl.innerText = total.toFixed(2) + " OMR";
        totalEl.setAttribute('data-base-price', total);

        // تحديث العملة إذا لزم الأمر
        if(typeof changeCurrency === 'function') {
            const current = localStorage.getItem('selectedCurrency') || 'OMR';
            changeCurrency(current);
        }
    }

    async function validateCoupon() {
        const code = document.getElementById('couponInput').value;
        const hiddenInput = document.getElementById('hiddenCouponCode');
        const feedback = document.getElementById('couponFeedback');

        // إذا كان الحقل فارغاً، نلغي الكوبون
        if(!code) {
             hiddenInput.value = "";
             currentDiscountAmount = 0;
             calculateTotals();
             feedback.innerText = "";
             return;
        }

        feedback.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const response = await fetch(`/Cart/ValidateCoupon?code=${code}`, { method: 'POST' });
            const result = await response.json();

            if (result.valid) {
                feedback.innerText = result.message;
                feedback.className = 'coupon-feedback success';

                // تحديث قيمة الخصم العالمية
                currentDiscountAmount = parseFloat(result.discountAmount);

                // **تحديث الحقل المخفي ليتم إرساله للسيرفر عند الحفظ**
                hiddenInput.value = code;

                calculateTotals();
            } else {
                feedback.innerText = result.message;
                feedback.className = 'coupon-feedback error';

                currentDiscountAmount = 0;
                hiddenInput.value = ""; // إلغاء الكود من الحقل المخفي
                calculateTotals();
            }
        } catch (e) {
            feedback.innerText = "Error connecting to server";
            currentDiscountAmount = 0;
            hiddenInput.value = "";
            calculateTotals();
        }
    }
</script>